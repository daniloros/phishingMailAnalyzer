<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Email Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">Phishing Detection System</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/analyzer">Analyzer</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/comparison">Comparison</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main content -->
<div class="container mt-4">
    <h1 class="mb-4">Email Analyzer</h1>

    <!-- Opzioni per l'analisi dell'email -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Scegli come analizzare l'email</h4>
        </div>
        <div class="card-body">
            <p>Seleziona una delle seguenti opzioni:</p>
            <div class="d-flex gap-3 mb-4">
                <a href="/upload" class="btn btn-primary">Carica file .eml</a>
                <button class="btn btn-secondary" id="showManualInput">Inserisci testo manualmente</button>
            </div>
        </div>
    </div>

    <!-- Sezione per visualizzare i dettagli dell'email (se disponibili) -->
    <div id="emailDetailsSection" th:if="${emailContent != null and !emailContent.isEmpty()}">
        <!-- Dettagli dell'email -->
<!--        <div class="card mb-4">-->
<!--            <div class="card-header">-->
<!--                <h4>Dettagli Email</h4>-->
<!--            </div>-->
<!--            <div class="card-body">-->
<!--                <h5>Oggetto: <span id="emailSubjectDisplay" th:text="${emailSubject}"></span></h5>-->
<!--                <div class="mt-3">-->
<!--                    <h6>Contenuto:</h6>-->
<!--                    <div id="emailTextDisplay" class="border p-3 bg-light" th:text="${emailContent}">-->
<!--                        &lt;!&ndash; Il contenuto dell'email verrà inserito qui &ndash;&gt;-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

        <!-- URL trovati nell'email -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>URL trovati nell'email</h4>
            </div>
            <div class="card-body">
                <div id="urlListDisplay">
                    <div th:if="${urls != null and !urls.empty}">
                        <ul class="list-group" id="urlsList">
                            <li th:each="url : ${urls}" class="list-group-item">
                                <a th:href="${url.startsWith('http') ? url : 'http://' + url}" target="_blank" th:text="${url}">URL</a>
                            </li>
                        </ul>
                    </div>
                    <div id="noUrlsFound" th:if="${urls == null or urls.empty}" class="alert alert-info">
                        Nessun URL trovato in questa email.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form di analisi dell'email (per input manuale) -->
    <div id="manualInputSection">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Analisi Email</h4>
            </div>
            <div class="card-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="emailText" class="form-label">Testo dell'email</label>
                        <textarea th:attr="disabled=${emailContent != null and !emailContent.isEmpty()}"
                                class="form-control" id="emailText" rows="10" required th:text="${emailContent}"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Classificatore</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="classifier" id="rf" value="rf" checked>
                    <label class="form-check-label" for="rf">Random Forest</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="classifier" id="svm" value="svm">
                    <label class="form-check-label" for="svm">SVM</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="classifier" id="xgboost" value="xgboost">
                    <label class="form-check-label" for="xgboost">XGBoost</label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" onclick="analyzeEmail(event)">Analizza</button>
        </div>
    </div>

    <!-- Risultati dell'analisi -->
    <div id="resultSection" style="display: none;">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Risultato Analisi</h4>
                <span id="resultBadge" class="badge rounded-pill"></span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Dettagli:</h5>
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Classificatore
                                <span id="classifierName"></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Numero di token
                                <span id="tokenCount"></span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Feedback:</h5>
                        <p>Questa previsione è corretta?</p>
                        <div class="d-flex">
                            <button id="feedbackYes" class="btn btn-outline-success me-2">Sì</button>
                            <button id="feedbackNo" class="btn btn-outline-danger">No</button>
                        </div>
                        <div id="feedbackMessage" class="alert mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Riferimenti agli elementi DOM
        const manualBtn = document.getElementById('showManualInput');
        const manualSection = document.getElementById('manualInputSection');

        // All'inizio nascondi la sezione di input manuale se ci sono dati di email caricati
        const emailContent = document.getElementById('emailText').value;
        if (emailContent.trim() !== '') {
            manualSection.style.display = 'block';
        } else {
            manualSection.style.display = 'none';
        }

        // Mostra/nascondi quando si clicca sul pulsante
        manualBtn.addEventListener('click', function() {
            manualSection.style.display = manualSection.style.display === 'none' ? 'block' : 'none';
        });

        // Gestione del form per l'analisi dell'email
        const emailForm = document.getElementById('emailForm');
        if (emailForm) {
            emailForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const emailText = document.getElementById('emailText').value;
                if (!emailText) {
                    alert('Inserisci il testo dell\'email');
                    return;
                }

                // Ottieni il classificatore selezionato
                const classifier = document.querySelector('input[name="classifier"]:checked').value;

                // Prepara i dati per l'API
                const requestData = {
                    text: emailText
                };

                // Mostra un indicatore di caricamento
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analisi in corso...';
                submitBtn.disabled = true;

                // Effettua la richiesta all'API
                fetch(`/api/analyze/${classifier}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Errore durante l\'analisi');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Ripristina il pulsante
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.disabled = false;

                        // Visualizza i risultati
                        displayResults(data);
                    })
                    .catch(error => {
                        console.error('Errore:', error);
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.disabled = false;
                        alert('Errore durante l\'analisi: ' + error.message);
                    });
            });
        }
    });

    // Funzione per visualizzare i risultati
    function displayResults(data) {
        // Mostra la sezione dei risultati
        const resultSection = document.getElementById('resultSection');
        resultSection.style.display = 'block';

        // Aggiorna il badge del risultato
        const resultBadge = document.getElementById('resultBadge');
        if (data.phishing) {
            resultBadge.textContent = 'PHISHING';
            resultBadge.className = 'badge rounded-pill bg-danger';
        } else {
            resultBadge.textContent = 'LEGITTIMA';
            resultBadge.className = 'badge rounded-pill bg-success';
        }

        // Aggiorna i dettagli
        document.getElementById('classifierName').textContent = data.classifier;
        document.getElementById('tokenCount').textContent = data.numTokens;

        // Configura i pulsanti di feedback
        setupFeedbackButtons(data);
    }

    function analyzeEmail(e) {
        e.preventDefault();

        const emailText = document.getElementById('emailText').value;
        if (!emailText) {
            alert('Inserisci il testo dell\'email');
            return;
        }

        // Ottieni il classificatore selezionato
        const classifier = document.querySelector('input[name="classifier"]:checked').value;

        // Prepara i dati per l'API
        const requestData = {
            text: emailText
        };

        // Effettua la richiesta all'API
        fetch(`/api/analyze/${classifier}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore durante l\'analisi');
                }
                return response.json();
            })
            .then(data => {
                // Visualizza i risultati
                displayResults(data);
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore durante l\'analisi: ' + error.message);
            });
    }

    // Configura i pulsanti di feedback
    function setupFeedbackButtons(data) {
        const yesBtn = document.getElementById('feedbackYes');
        const noBtn = document.getElementById('feedbackNo');
        const feedbackMessage = document.getElementById('feedbackMessage');

        // Ripristina lo stato dei pulsanti
        yesBtn.disabled = false;
        noBtn.disabled = false;
        feedbackMessage.style.display = 'none';

        // Aggiungi handler per il pulsante Sì (conferma la previsione)
        yesBtn.onclick = function() {
            sendFeedback(data, data.isPhishing);
        };

        // Aggiungi handler per il pulsante No (inverte la previsione)
        noBtn.onclick = function() {
            sendFeedback(data, !data.isPhishing);
        };

        // Funzione per inviare il feedback
        function sendFeedback(data, userFeedback) {
            // Disabilita entrambi i pulsanti durante l'invio
            yesBtn.disabled = true;
            noBtn.disabled = true;

            // Prepara i dati per l'API
            const feedbackData = {
                emailText: data.text,
                userFeedback: userFeedback,
                classifier: data.classifier,
                resultId: data.resultId
            };

            // Effettua la richiesta all'API
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(feedbackData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Errore durante l\'invio del feedback');
                    }
                    return response.json();
                })
                .then(response => {
                    // Mostra il messaggio di successo
                    feedbackMessage.className = 'alert alert-success mt-3';
                    feedbackMessage.textContent = 'Grazie per il tuo feedback!';
                    feedbackMessage.style.display = 'block';
                })
                .catch(error => {
                    console.error('Errore:', error);

                    // Riabilita i pulsanti in caso di errore
                    yesBtn.disabled = false;
                    noBtn.disabled = false;

                    // Mostra il messaggio di errore
                    feedbackMessage.className = 'alert alert-danger mt-3';
                    feedbackMessage.textContent = 'Errore durante l\'invio del feedback: ' + error.message;
                    feedbackMessage.style.display = 'block';
                });
        }
    }

</script>
</body>
</html>