<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Confronta Classificatori</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">Phishing Detection System</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/analyzer">Analizza Mail</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/comparison">Confronta Classificatori</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main content -->
<div class="container mt-4">
    <h1 class="mb-4">Classifier Comparison</h1>

    <!-- Opzioni per l'analisi dell'email -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Scegli come analizzare l'email</h4>
        </div>
        <div class="card-body">
            <p>Seleziona una delle seguenti opzioni:</p>
            <div class="d-flex gap-3 mb-4">
                <a href="/upload?origin=comparison" class="btn btn-primary">Carica file .eml</a>
                <button class="btn btn-secondary" id="showManualInput">Inserisci testo manualmente</button>
            </div>
        </div>
    </div>

    <!-- Sezione per visualizzare i dettagli dell'email (se disponibili) -->
    <div id="emailDetailsSection" th:if="${emailContent != null and !emailContent.isEmpty()}">
        <!-- URL trovati nell'email -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>URL trovati nell'email</h4>
            </div>
            <div class="card-body">
                <div id="urlListDisplay">
                    <div th:if="${urls != null and !urls.empty}">
                        <ul class="list-group" id="urlsList">
                            <li th:each="url : ${urls}" class="list-group-item">
                                <a th:href="${url.startsWith('http') ? url : 'http://' + url}" target="_blank"
                                   th:text="${url}">URL</a>
                            </li>
                        </ul>
                    </div>
                    <div id="noUrlsFound" th:if="${urls == null or urls.empty}" class="alert alert-info">
                        Nessun URL trovato in questa email.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form di analisi dell'email (per input manuale) -->
    <div id="manualInputSection">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Confronto Classificatori</h4>
            </div>
            <div class="card-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="emailText" class="form-label">Testo dell'email</label>
                        <textarea th:attr="disabled=${emailContent != null and !emailContent.isEmpty()}"
                                  class="form-control" id="emailText" rows="10" required
                                  th:text="${emailContent}"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-body">
            <p>Questa operazione confronterà l'email con tutti i classificatori disponibili.</p>
            <button type="submit" class="btn btn-primary" onclick="compareClassifiers(event)">Confronta Classificatori
            </button>
            <div id="loadingSpinner" class="mt-3 text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Analisi in corso...</span>
                </div>
                <p class="mt-2">Analisi in corso con tutti i classificatori...</p>
            </div>
        </div>
    </div>

    <!-- Risultati dell'analisi -->
    <div id="resultSection" style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Risultati Comparazione</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Classificatore</th>
                            <th>Risultato</th>
                            <th>Feedback</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="rf-result-row">
                            <td>Random Forest</td>
                            <td><span id="rf-badge" class="badge rounded-pill">In attesa...</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" id="rf-yes">Corretto</button>
                                    <button class="btn btn-sm btn-outline-danger" id="rf-no">Errato</button>
                                </div>
                            </td>
                        </tr>
                        <tr id="svm-result-row">
                            <td>SVM</td>
                            <td><span id="svm-badge" class="badge rounded-pill">In attesa...</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" id="svm-yes">Corretto</button>
                                    <button class="btn btn-sm btn-outline-danger" id="svm-no">Errato</button>
                                </div>
                            </td>
                        </tr>
                        <tr id="xgboost-result-row">
                            <td>XGBoost</td>
                            <td><span id="xgboost-badge" class="badge rounded-pill">In attesa...</span></td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-success" id="xgboost-yes">Corretto</button>
                                    <button class="btn btn-sm btn-outline-danger" id="xgboost-no">Errato</button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4">
                    <h5>Dettagli Email:</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Numero di token
                            <span id="tokenCount"></span>
                        </li>
                    </ul>
                </div>

                <div id="feedbackMessage" class="alert mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Riferimenti agli elementi DOM
        const manualBtn = document.getElementById('showManualInput');
        const manualSection = document.getElementById('manualInputSection');

        // All'inizio nascondi la sezione di input manuale se ci sono dati di email caricati
        const emailContent = document.getElementById('emailText').value;
        if (emailContent.trim() !== '') {
            manualSection.style.display = 'block';
        } else {
            manualSection.style.display = 'none';
        }

        // Mostra/nascondi quando si clicca sul pulsante
        manualBtn.addEventListener('click', function () {
            manualSection.style.display = manualSection.style.display === 'none' ? 'block' : 'none';
        });
    });

    // Funzione per confrontare i classificatori
    function compareClassifiers(e) {
        e.preventDefault();

        const emailText = document.getElementById('emailText').value;
        if (!emailText) {
            alert('Inserisci il testo dell\'email');
            return;
        }

        // Prepara i dati per l'API
        const requestData = {
            text: emailText
        };

        // Mostra lo spinner di caricamento
        const loadingSpinner = document.getElementById('loadingSpinner');
        loadingSpinner.style.display = 'block';

        // Disabilita il pulsante durante l'analisi
        const compareBtn = document.querySelector('button[onclick="compareClassifiers(event)"]');
        compareBtn.disabled = true;

        // Effettua la richiesta all'API
        fetch('/api/analyze/compare', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore durante l\'analisi di confronto');
                }
                return response.json();
            })
            .then(data => {
                // Nascondi lo spinner
                loadingSpinner.style.display = 'none';
                // Riabilita il pulsante
                compareBtn.disabled = false;
                // Visualizza i risultati
                displayComparisonResults(data);
            })
            .catch(error => {
                console.error('Errore:', error);
                // Nascondi lo spinner anche in caso di errore
                loadingSpinner.style.display = 'none';
                // Riabilita il pulsante
                compareBtn.disabled = false;
                alert('Errore durante l\'analisi di confronto: ' + error.message);
            });
    }

    // Funzione per visualizzare i risultati del confronto
    function displayComparisonResults(data) {
        console.log("Dati risultati confronto:", data);

        // Mostra la sezione dei risultati
        const resultSection = document.getElementById('resultSection');
        resultSection.style.display = 'block';

        // Aggiorna i badge dei risultati
        updateResultBadge('rf', data.rfPrediction);
        updateResultBadge('svm', data.svmPrediction);
        updateResultBadge('xgboost', data.xgboostPrediction);

        // Aggiorna il numero di token
        document.getElementById('tokenCount').textContent = data.numTokens || 'N/A';

        // Configura i pulsanti di feedback
        setupFeedbackButton('rf', data.rfResultId, data.emailText, data.rfPrediction);
        setupFeedbackButton('svm', data.svmResultId, data.emailText, data.svmPrediction);
        setupFeedbackButton('xgboost', data.xgboostResultId, data.emailText, data.xgboostPrediction);
    }

    // Funzione per aggiornare i badge dei risultati
    function updateResultBadge(classifier, isPhishing) {
        const badge = document.getElementById(`${classifier}-badge`);
        if (isPhishing) {
            badge.textContent = 'PHISHING';
            badge.className = 'badge rounded-pill bg-danger';
        } else {
            badge.textContent = 'LEGITTIMA';
            badge.className = 'badge rounded-pill bg-success';
        }
    }

    // Funzione per configurare i pulsanti di feedback
    function setupFeedbackButton(classifier, resultId, emailText, prediction) {
        const yesBtn = document.getElementById(`${classifier}-yes`);
        const noBtn = document.getElementById(`${classifier}-no`);

        // Ripristina lo stato dei pulsanti
        yesBtn.disabled = false;
        noBtn.disabled = false;

        // Aggiungi handler per il pulsante "Corretto" (conferma la previsione)
        yesBtn.onclick = function () {
            sendFeedback(classifier, resultId, emailText, prediction);
        };

        // Aggiungi handler per il pulsante "Errato" (inverte la previsione)
        noBtn.onclick = function () {
            sendFeedback(classifier, resultId, emailText, !prediction);
        };
    }

    // Funzione per inviare il feedback
    function sendFeedback(classifier, resultId, emailText, userFeedback) {
        // Disabilita i pulsanti durante l'invio
        const yesBtn = document.getElementById(`${classifier}-yes`);
        const noBtn = document.getElementById(`${classifier}-no`);
        yesBtn.disabled = true;
        noBtn.disabled = true;

        // Prepara i dati per l'API
        const feedbackData = {
            emailText: emailText,
            userFeedback: userFeedback,
            classifier: classifier,
            resultId: resultId
        };

        // Mostra indicatore di caricamento nel pulsante
        const clickedBtn = userFeedback === true ? yesBtn : noBtn;
        const originalBtnText = clickedBtn.innerHTML;
        clickedBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        // Effettua la richiesta all'API
        fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(feedbackData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore durante l\'invio del feedback');
                }
                return response.json();
            })
            .then(response => {
                // Ripristina il testo del pulsante
                clickedBtn.innerHTML = originalBtnText;

                // Disabilita entrambi i pulsanti dopo il successo
                yesBtn.disabled = true;
                noBtn.disabled = true;

                // Aggiungi una classe per mostrare quale feedback è stato inviato
                clickedBtn.classList.remove('btn-outline-success', 'btn-outline-danger');
                clickedBtn.classList.add(userFeedback ? 'btn-success' : 'btn-danger');

                // Mostra un messaggio temporaneo
                const feedbackMessage = document.getElementById('feedbackMessage');
                feedbackMessage.className = 'alert alert-success mt-3';
                feedbackMessage.textContent = `Feedback inviato con successo per il classificatore ${classifier.toUpperCase()}`;
                feedbackMessage.style.display = 'block';

                // Nascondi il messaggio dopo 3 secondi
                setTimeout(() => {
                    feedbackMessage.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Errore:', error);

                // Ripristina il testo del pulsante
                clickedBtn.innerHTML = originalBtnText;

                // Riabilita i pulsanti in caso di errore
                yesBtn.disabled = false;
                noBtn.disabled = false;

                // Mostra il messaggio di errore
                const feedbackMessage = document.getElementById('feedbackMessage');
                feedbackMessage.className = 'alert alert-danger mt-3';
                 feedbackMessage.textContent = 'Errore durante l\'invio del feedback: ' + error.message;
                feedbackMessage.style.display = 'block';
            });
    }
</script>
</body>
</html>